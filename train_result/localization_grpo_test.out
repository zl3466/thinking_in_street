W0403 01:40:52.397000 2671481 site-packages/torch/distributed/run.py:792] 
W0403 01:40:52.397000 2671481 site-packages/torch/distributed/run.py:792] *****************************************
W0403 01:40:52.397000 2671481 site-packages/torch/distributed/run.py:792] Setting OMP_NUM_THREADS environment variable for each process to be 1 in default, to avoid your system being overloaded, please further tune the variable for optimal performance in your application as needed. 
W0403 01:40:52.397000 2671481 site-packages/torch/distributed/run.py:792] *****************************************
[2025-04-03 01:41:55,851] [INFO] [real_accelerator.py:239:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-04-03 01:41:55,851] [INFO] [real_accelerator.py:239:get_accelerator] Setting ds_accelerator to cuda (auto detect)
[2025-04-03 01:42:24,150] [INFO] [comm.py:658:init_distributed] cdb=None
[2025-04-03 01:42:24,152] [INFO] [comm.py:658:init_distributed] cdb=None
[2025-04-03 01:42:24,152] [INFO] [comm.py:689:init_distributed] Initializing TorchBackend in DeepSpeed with backend nccl
Processing train dataset into examples...
Processing train dataset into examples...
Processing test dataset into examples...
Processing test dataset into examples...
Generating train split: 0 examples [00:00, ? examples/s]Generating train split: 462 examples [00:00, 4470.65 examples/s]Generating train split: 462 examples [00:00, 4353.41 examples/s]
Generating train split: 0 examples [00:00, ? examples/s]Generating train split: 476 examples [00:00, 29891.14 examples/s]
Map:   0%|          | 0/462 [00:00<?, ? examples/s]Map:   0%|          | 0/462 [00:00<?, ? examples/s]Map: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 462/462 [00:00<00:00, 6903.15 examples/s]
Map:   0%|          | 0/476 [00:00<?, ? examples/s]Map: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 462/462 [00:00<00:00, 6479.08 examples/s]
Map:   0%|          | 0/476 [00:00<?, ? examples/s]Map: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 476/476 [00:00<00:00, 7103.48 examples/s]
using:  <class 'trainer.grpo_trainer.Qwen2VLGRPOTrainer'>
Qwen/Qwen2.5-VL-7B-Instruct
Map: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 476/476 [00:00<00:00, 7346.05 examples/s]
using:  <class 'trainer.grpo_trainer.Qwen2VLGRPOTrainer'>
Qwen/Qwen2.5-VL-7B-Instruct
[2025-04-03 01:42:39,983] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
[2025-04-03 01:42:39,983] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
You are attempting to use Flash Attention 2.0 without specifying a torch dtype. This might lead to unexpected behaviour
You are attempting to use Flash Attention 2.0 with a model not initialized on GPU. Make sure to move the model to GPU after initializing it on CPU with `model.to('cuda')`.
You are attempting to use Flash Attention 2.0 without specifying a torch dtype. This might lead to unexpected behaviour
You are attempting to use Flash Attention 2.0 with a model not initialized on GPU. Make sure to move the model to GPU after initializing it on CPU with `model.to('cuda')`.
Flash Attention 2.0 only supports torch.float16 and torch.bfloat16 dtypes, but the current dype in Qwen2_5_VisionTransformerPretrainedModel is torch.float32. You should run training or inference using Automatic Mixed-Precision via the `with torch.autocast(device_type='torch_device'):` decorator, or load the model with the `torch_dtype` argument. Example: `model = AutoModel.from_pretrained("openai/whisper-tiny", attn_implementation="flash_attention_2", torch_dtype=torch.float16)`
Flash Attention 2.0 only supports torch.float16 and torch.bfloat16 dtypes, but the current dype in Qwen2_5_VisionTransformerPretrainedModel is torch.float32. You should run training or inference using Automatic Mixed-Precision via the `with torch.autocast(device_type='torch_device'):` decorator, or load the model with the `torch_dtype` argument. Example: `model = AutoModel.from_pretrained("openai/whisper-tiny", attn_implementation="flash_attention_2", torch_dtype=torch.float16)`
[2025-04-03 01:42:41,569] [INFO] [partition_parameters.py:348:__exit__] finished initializing model - num_params = 729, num_elems = 8.29B
Loading checkpoint shards:   0%|          | 0/5 [00:00<?, ?it/s]Loading checkpoint shards:   0%|          | 0/5 [00:00<?, ?it/s]Loading checkpoint shards:  20%|‚ñà‚ñà        | 1/5 [00:13<00:54, 13.70s/it]Loading checkpoint shards:  20%|‚ñà‚ñà        | 1/5 [00:14<00:56, 14.10s/it]Loading checkpoint shards:  40%|‚ñà‚ñà‚ñà‚ñà      | 2/5 [00:24<00:36, 12.18s/it]Loading checkpoint shards:  40%|‚ñà‚ñà‚ñà‚ñà      | 2/5 [00:24<00:36, 12.16s/it]Loading checkpoint shards:  60%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 3/5 [00:42<00:29, 14.51s/it]Loading checkpoint shards:  60%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 3/5 [00:42<00:29, 14.60s/it]Loading checkpoint shards:  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 4/5 [00:58<00:15, 15.07s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:58<00:00,  9.77s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:58<00:00, 11.70s/it]
[2025-04-03 01:43:40,389] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
Loading checkpoint shards:  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 4/5 [00:58<00:15, 15.24s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [01:00<00:00, 10.47s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [01:00<00:00, 12.11s/it]
[2025-04-03 01:43:42,667] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
Loading checkpoint shards:   0%|          | 0/5 [00:00<?, ?it/s][2025-04-03 01:43:43,019] [INFO] [partition_parameters.py:348:__exit__] finished initializing model - num_params = 1458, num_elems = 16.58B
Loading checkpoint shards:   0%|          | 0/5 [00:00<?, ?it/s]Loading checkpoint shards:  20%|‚ñà‚ñà        | 1/5 [00:04<00:18,  4.51s/it]Loading checkpoint shards:  20%|‚ñà‚ñà        | 1/5 [00:04<00:17,  4.39s/it]Loading checkpoint shards:  40%|‚ñà‚ñà‚ñà‚ñà      | 2/5 [00:07<00:10,  3.62s/it]Loading checkpoint shards:  40%|‚ñà‚ñà‚ñà‚ñà      | 2/5 [00:07<00:10,  3.58s/it]Loading checkpoint shards:  60%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 3/5 [00:10<00:06,  3.32s/it]Loading checkpoint shards:  60%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà    | 3/5 [00:10<00:06,  3.36s/it]Loading checkpoint shards:  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 4/5 [00:13<00:03,  3.19s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:13<00:00,  2.14s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:13<00:00,  2.75s/it]
Loading checkpoint shards:  80%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  | 4/5 [00:13<00:03,  3.26s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:14<00:00,  2.52s/it]Loading checkpoint shards: 100%|‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà| 5/5 [00:14<00:00,  2.96s/it]
[2025-04-03 01:43:58,618] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
[2025-04-03 01:43:59,547] [INFO] [logging.py:107:log_dist] [Rank 0] DeepSpeed info: version=0.16.5, git-hash=unknown, git-branch=unknown
[2025-04-03 01:43:59,548] [INFO] [config.py:734:__init__] Config mesh_device None world_size = 2
[2025-04-03 01:43:59,572] [INFO] [logging.py:107:log_dist] [Rank 0] DeepSpeed Flops Profiler Enabled: False
[2025-04-03 01:43:59,575] [INFO] [logging.py:107:log_dist] [Rank 0] Creating ZeRO Offload
[2025-04-03 01:44:00,188] [INFO] [utils.py:781:see_memory_usage] DeepSpeedZeRoOffload initialize [begin]
[2025-04-03 01:44:00,189] [INFO] [utils.py:782:see_memory_usage] MA 15.48 GB         Max_MA 18.02 GB         CA 18.46 GB         Max_CA 18 GB 
[2025-04-03 01:44:00,189] [INFO] [utils.py:789:see_memory_usage] CPU Virtual Memory:  used = 46.15 GB, percent = 12.2%
Parameter Offload: Total persistent parameters: 848896 in 368 params
[2025-04-03 01:44:00,678] [INFO] [utils.py:781:see_memory_usage] DeepSpeedZeRoOffload initialize [end]
[2025-04-03 01:44:00,679] [INFO] [utils.py:782:see_memory_usage] MA 15.48 GB         Max_MA 15.48 GB         CA 18.46 GB         Max_CA 18 GB 
[2025-04-03 01:44:00,679] [INFO] [utils.py:789:see_memory_usage] CPU Virtual Memory:  used = 48.78 GB, percent = 12.9%
[2025-04-03 01:44:00,681] [INFO] [config.py:1000:print] DeepSpeedEngine configuration:
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   activation_checkpointing_config  {
    "partition_activations": false, 
    "contiguous_memory_optimization": false, 
    "cpu_checkpointing": false, 
    "number_checkpoints": null, 
    "synchronize_checkpoint_boundary": false, 
    "profile": false
}
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   aio_config ................... {'block_size': 1048576, 'queue_depth': 8, 'intra_op_parallelism': 1, 'single_submit': False, 'overlap_events': True, 'use_gds': False}
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   amp_enabled .................. False
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   amp_params ................... False
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   autotuning_config ............ {
    "enabled": false, 
    "start_step": null, 
    "end_step": null, 
    "metric_path": null, 
    "arg_mappings": null, 
    "metric": "throughput", 
    "model_info": null, 
    "results_dir": "autotuning_results", 
    "exps_dir": "autotuning_exps", 
    "overwrite": true, 
    "fast": true, 
    "start_profile_step": 3, 
    "end_profile_step": 5, 
    "tuner_type": "gridsearch", 
    "tuner_early_stopping": 5, 
    "tuner_num_trials": 50, 
    "model_info_path": null, 
    "mp_size": 1, 
    "max_train_batch_size": null, 
    "min_train_batch_size": 1, 
    "max_train_micro_batch_size_per_gpu": 1.024000e+03, 
    "min_train_micro_batch_size_per_gpu": 1, 
    "num_tuning_micro_batch_sizes": 3
}
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   bfloat16_enabled ............. True
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   bfloat16_immediate_grad_update  True
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   checkpoint_parallel_write_pipeline  False
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   checkpoint_tag_validation_enabled  True
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   checkpoint_tag_validation_fail  False
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   comms_config ................. <deepspeed.comm.config.DeepSpeedCommsConfig object at 0x1530c4865250>
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   communication_data_type ...... None
[2025-04-03 01:44:00,682] [INFO] [config.py:1004:print]   compression_config ........... {'weight_quantization': {'shared_parameters': {'enabled': False, 'quantizer_kernel': False, 'schedule_offset': 0, 'quantize_groups': 1, 'quantize_verbose': False, 'quantization_type': 'symmetric', 'quantize_weight_in_forward': False, 'rounding': 'nearest', 'fp16_mixed_quantize': False, 'quantize_change_ratio': 0.001}, 'different_groups': {}}, 'activation_quantization': {'shared_parameters': {'enabled': False, 'quantization_type': 'symmetric', 'range_calibration': 'dynamic', 'schedule_offset': 1000}, 'different_groups': {}}, 'sparse_pruning': {'shared_parameters': {'enabled': False, 'method': 'l1', 'schedule_offset': 1000}, 'different_groups': {}}, 'row_pruning': {'shared_parameters': {'enabled': False, 'method': 'l1', 'schedule_offset': 1000}, 'different_groups': {}}, 'head_pruning': {'shared_parameters': {'enabled': False, 'method': 'topk', 'schedule_offset': 1000}, 'different_groups': {}}, 'channel_pruning': {'shared_parameters': {'enabled': False, 'method': 'l1', 'schedule_offset': 1000}, 'different_groups': {}}, 'layer_reduction': {'enabled': False}}
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   curriculum_enabled_legacy .... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   curriculum_params_legacy ..... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   data_efficiency_config ....... {'enabled': False, 'seed': 1234, 'data_sampling': {'enabled': False, 'num_epochs': 1000, 'num_workers': 0, 'pin_memory': False, 'curriculum_learning': {'enabled': False}, 'dynamic_batching': {'enabled': False, 'lr_scaling_method': 'linear', 'min_batch_size': 1, 'max_batch_size': None, 'sequence_picking_order': 'dataloader', 'verbose': False}}, 'data_routing': {'enabled': False, 'random_ltd': {'enabled': False, 'layer_token_lr_schedule': {'enabled': False}}}}
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   data_efficiency_enabled ...... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   dataloader_drop_last ......... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   disable_allgather ............ False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   dump_state ................... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   dynamic_loss_scale_args ...... None
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_enabled ........... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_gas_boundary_resolution  1
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_layer_name ........ bert.encoder.layer
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_layer_num ......... 0
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_max_iter .......... 100
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_stability ......... 1e-06
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_tol ............... 0.01
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   eigenvalue_verbose ........... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   elasticity_enabled ........... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   flops_profiler_config ........ {
    "enabled": false, 
    "recompute_fwd_factor": 0.0, 
    "profile_step": 1, 
    "module_depth": -1, 
    "top_modules": 1, 
    "detailed": true, 
    "output_file": null
}
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   fp16_auto_cast ............... None
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   fp16_enabled ................. False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   fp16_master_weights_and_gradients  False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   global_rank .................. 0
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   grad_accum_dtype ............. None
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   gradient_accumulation_steps .. 1
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   gradient_clipping ............ 5.0
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   gradient_predivide_factor .... 1.0
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   graph_harvesting ............. False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   hybrid_engine ................ enabled=False max_out_tokens=512 inference_tp_size=1 release_inference_cache=False pin_parameters=True tp_gather_partition_size=8
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   initial_dynamic_scale ........ 1
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   load_universal_checkpoint .... False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   loss_scale ................... 1.0
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   memory_breakdown ............. False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   mics_hierarchial_params_gather  False
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   mics_shard_size .............. -1
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   monitor_config ............... tensorboard=TensorBoardConfig(enabled=False, output_path='', job_name='DeepSpeedJobName') comet=CometConfig(enabled=False, samples_log_interval=100, project=None, workspace=None, api_key=None, experiment_name=None, experiment_key=None, online=None, mode=None) wandb=WandbConfig(enabled=False, group=None, team=None, project='deepspeed') csv_monitor=CSVConfig(enabled=False, output_path='', job_name='DeepSpeedJobName')
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   nebula_config ................ {
    "enabled": false, 
    "persistent_storage_path": null, 
    "persistent_time_interval": 100, 
    "num_of_version_in_retention": 2, 
    "enable_nebula_load": true, 
    "load_path": null
}
[2025-04-03 01:44:00,683] [INFO] [config.py:1004:print]   optimizer_legacy_fusion ...... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   optimizer_name ............... None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   optimizer_params ............. None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   pipeline ..................... {'stages': 'auto', 'partition': 'best', 'seed_layers': False, 'activation_checkpoint_interval': 0, 'pipe_partitioned': True, 'grad_partitioned': True}
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   pld_enabled .................. False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   pld_params ................... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   prescale_gradients ........... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   scheduler_name ............... None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   scheduler_params ............. None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   seq_parallel_communication_data_type  torch.float32
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   sparse_attention ............. None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   sparse_gradients_enabled ..... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   steps_per_print .............. inf
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   tensor_parallel_config ....... dtype=torch.float16 autotp_size=0 tensor_parallel=TPConfig(tp_size=1, tp_grain_size=1, mpu=None, tp_group=None) injection_policy_tuple=None keep_module_on_host=False replace_with_kernel_inject=False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   timers_config ................ enabled=True synchronized=True
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   train_batch_size ............. 2
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   train_micro_batch_size_per_gpu  1
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   use_data_before_expert_parallel_  False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   use_node_local_storage ....... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   wall_clock_breakdown ......... False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   weight_quantization_config ... None
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   world_size ................... 2
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   zero_allow_untested_optimizer  False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   zero_config .................. stage=3 contiguous_gradients=True reduce_scatter=True reduce_bucket_size=500000000 use_multi_rank_bucket_allreduce=True allgather_partitions=True allgather_bucket_size=500000000 overlap_comm=True load_from_fp32_weights=True elastic_checkpoint=False offload_param=DeepSpeedZeroOffloadParamConfig(device='none', nvme_path=None, buffer_count=5, buffer_size=100000000, max_in_cpu=1000000000, pin_memory=True) offload_optimizer=DeepSpeedZeroOffloadOptimizerConfig(device='none', nvme_path=None, buffer_count=4, pin_memory=True, pipeline_read=False, pipeline_write=False, fast_init=False, ratio=1.0) sub_group_size=1000000000 cpu_offload_param=None cpu_offload_use_pin_memory=None cpu_offload=None prefetch_bucket_size=50000000 param_persistence_threshold=100000 model_persistence_threshold=9223372036854775807 max_live_parameters=1000000000 max_reuse_distance=1000000000 gather_16bit_weights_on_model_save=True module_granularity_threshold=0 use_all_reduce_for_fetch_params=False stage3_gather_fp16_weights_on_model_save=False ignore_unused_parameters=True legacy_stage1=False round_robin_gradients=False zero_hpz_partition_size=1 zero_quantized_weights=False zero_quantized_nontrainable_weights=False zero_quantized_gradients=False zeropp_loco_param=None mics_shard_size=-1 mics_hierarchical_params_gather=False memory_efficient_linear=True pipeline_loading_checkpoint=False override_module_apply=True log_trace_cache_warnings=False
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   zero_enabled ................. True
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   zero_force_ds_cpu_optimizer .. True
[2025-04-03 01:44:00,684] [INFO] [config.py:1004:print]   zero_optimization_stage ...... 3
[2025-04-03 01:44:00,684] [INFO] [config.py:990:print_user_config]   json = {
    "fp16": {
        "enabled": false, 
        "loss_scale": 0, 
        "loss_scale_window": 1000, 
        "initial_scale_power": 16, 
        "hysteresis": 2, 
        "min_loss_scale": 1
    }, 
    "bf16": {
        "enabled": true
    }, 
    "zero_optimization": {
        "stage": 3, 
        "offload_optimizer": {
            "device": "none", 
            "pin_memory": true
        }, 
        "offload_param": {
            "device": "none", 
            "pin_memory": true
        }, 
        "overlap_comm": true, 
        "contiguous_gradients": true, 
        "sub_group_size": 1.000000e+09, 
        "reduce_bucket_size": "auto", 
        "stage3_prefetch_bucket_size": "auto", 
        "stage3_param_persistence_threshold": "auto", 
        "stage3_max_live_parameters": 1.000000e+09, 
        "stage3_max_reuse_distance": 1.000000e+09, 
        "stage3_gather_16bit_weights_on_model_save": true
    }, 
    "gradient_accumulation_steps": 1, 
    "gradient_clipping": 5.0, 
    "steps_per_print": inf, 
    "train_batch_size": 2, 
    "train_micro_batch_size_per_gpu": 1, 
    "wall_clock_breakdown": false, 
    "zero_optimization.reduce_bucket_size": 1.284506e+07, 
    "zero_optimization.stage3_param_persistence_threshold": 3.584000e+04, 
    "zero_optimization.stage3_prefetch_bucket_size": 1.156055e+07
}
Parameter Offload: Total persistent parameters: 848896 in 368 params
wandb: Using wandb-core as the SDK backend.  Please refer to https://wandb.me/wandb-core for more information.
wandb: Currently logged in as: zl3466 (zl3466-new-york-university) to https://api.wandb.ai. Use `wandb login --relogin` to force relogin
wandb: Tracking run with wandb version 0.19.8
wandb: Run data is saved locally in /scratch/zl3466/github/thinking_in_street/wandb/run-20250403_014418-wolirl0z
wandb: Run `wandb offline` to turn off syncing.
wandb: Syncing run localization
wandb: ‚≠êÔ∏è View project at https://wandb.ai/zl3466-new-york-university/huggingface
wandb: üöÄ View run at https://wandb.ai/zl3466-new-york-university/huggingface/runs/wolirl0z
[rank1]: Traceback (most recent call last):
[rank1]:   File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 587, in <module>
[rank1]:     main(script_args, training_args, model_args)
[rank1]:   File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 576, in main
[rank1]:     trainer.train()
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2241, in train
[rank1]:     return inner_training_loop(
[rank1]:            ^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2548, in _inner_training_loop
[rank1]:     tr_loss_step = self.training_step(model, inputs, num_items_in_batch)
[rank1]:                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 3698, in training_step
[rank1]:     loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)
[rank1]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/github/thinking_in_street/train/localization/trainer/grpo_trainer.py", line 510, in compute_loss
[rank1]:     with unwrap_model_for_generation(model, self.accelerator) as unwrapped_model:
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/contextlib.py", line 137, in __enter__
[rank1]:     return next(self.gen)
[rank1]:            ^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/trl/models/utils.py", line 217, in unwrap_model_for_generation
[rank1]:     with deepspeed.zero.GatheredParameters(model.parameters()):
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 2243, in __enter__
[rank1]:     self.params[0].all_gather(param_list=self.params)
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1161, in all_gather
[rank1]:     return self._all_gather(param_list, async_op=async_op, hierarchy=hierarchy)
[rank1]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/utils/nvtx.py", line 20, in wrapped_fn
[rank1]:     ret_val = func(*args, **kwargs)
[rank1]:               ^^^^^^^^^^^^^^^^^^^^^
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1529, in _all_gather
[rank1]:     self._allgather_params_coalesced(all_gather_nonquantize_list, hierarchy, quantize=False)
[rank1]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1818, in _allgather_params_coalesced
[rank1]:     flat_tensor = torch.empty(tensor_size, dtype=param_list[0].ds_tensor.dtype,
[rank1]:                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank1]: torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 130.00 MiB. GPU 1 has a total capacity of 44.48 GiB of which 63.31 MiB is free. Including non-PyTorch memory, this process has 44.42 GiB memory in use. Of the allocated memory 44.10 GiB is allocated by PyTorch, and 51.77 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
  0%|          | 0/231 [00:00<?, ?it/s]Traceback (most recent call last):
  File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 587, in <module>
    main(script_args, training_args, model_args)
  File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 576, in main
    trainer.train()
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2241, in train
    return inner_training_loop(
           ^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2548, in _inner_training_loop
    tr_loss_step = self.training_step(model, inputs, num_items_in_batch)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 3698, in training_step
    loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/github/thinking_in_street/train/localization/trainer/grpo_trainer.py", line 510, in compute_loss
    with unwrap_model_for_generation(model, self.accelerator) as unwrapped_model:
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/contextlib.py", line 137, in __enter__
    return next(self.gen)
           ^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/trl/models/utils.py", line 217, in unwrap_model_for_generation
    with deepspeed.zero.GatheredParameters(model.parameters()):
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 2243, in __enter__
    self.params[0].all_gather(param_list=self.params)
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1161, in all_gather
    return self._all_gather(param_list, async_op=async_op, hierarchy=hierarchy)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/utils/nvtx.py", line 20, in wrapped_fn
    ret_val = func(*args, **kwargs)
              ^^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1529, in _all_gather
    self._allgather_params_coalesced(all_gather_nonquantize_list, hierarchy, quantize=False)
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1818, in _allgather_params_coalesced
    flat_tensor = torch.empty(tensor_size, dtype=param_list[0].ds_tensor.dtype,
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 130.00 MiB. GPU 0 has a total capacity of 44.48 GiB of which 83.31 MiB is free. Process 2671556 has 162.00 MiB memory in use. Including non-PyTorch memory, this process has 44.24 GiB memory in use. Of the allocated memory 43.92 GiB is allocated by PyTorch, and 52.45 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
[rank0]: Traceback (most recent call last):
[rank0]:   File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 587, in <module>
[rank0]:     main(script_args, training_args, model_args)
[rank0]:   File "/scratch/zl3466/github/thinking_in_street/./train/localization/grpo.py", line 576, in main
[rank0]:     trainer.train()
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2241, in train
[rank0]:     return inner_training_loop(
[rank0]:            ^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 2548, in _inner_training_loop
[rank0]:     tr_loss_step = self.training_step(model, inputs, num_items_in_batch)
[rank0]:                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/transformers/trainer.py", line 3698, in training_step
[rank0]:     loss = self.compute_loss(model, inputs, num_items_in_batch=num_items_in_batch)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/github/thinking_in_street/train/localization/trainer/grpo_trainer.py", line 510, in compute_loss
[rank0]:     with unwrap_model_for_generation(model, self.accelerator) as unwrapped_model:
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/contextlib.py", line 137, in __enter__
[rank0]:     return next(self.gen)
[rank0]:            ^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/trl/models/utils.py", line 217, in unwrap_model_for_generation
[rank0]:     with deepspeed.zero.GatheredParameters(model.parameters()):
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 2243, in __enter__
[rank0]:     self.params[0].all_gather(param_list=self.params)
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1161, in all_gather
[rank0]:     return self._all_gather(param_list, async_op=async_op, hierarchy=hierarchy)
[rank0]:            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/utils/nvtx.py", line 20, in wrapped_fn
[rank0]:     ret_val = func(*args, **kwargs)
[rank0]:               ^^^^^^^^^^^^^^^^^^^^^
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1529, in _all_gather
[rank0]:     self._allgather_params_coalesced(all_gather_nonquantize_list, hierarchy, quantize=False)
[rank0]:   File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/deepspeed/runtime/zero/partition_parameters.py", line 1818, in _allgather_params_coalesced
[rank0]:     flat_tensor = torch.empty(tensor_size, dtype=param_list[0].ds_tensor.dtype,
[rank0]:                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[rank0]: torch.OutOfMemoryError: CUDA out of memory. Tried to allocate 130.00 MiB. GPU 0 has a total capacity of 44.48 GiB of which 83.31 MiB is free. Process 2671556 has 162.00 MiB memory in use. Including non-PyTorch memory, this process has 44.24 GiB memory in use. Of the allocated memory 43.92 GiB is allocated by PyTorch, and 52.45 MiB is reserved by PyTorch but unallocated. If reserved but unallocated memory is large try setting PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True to avoid fragmentation.  See documentation for Memory Management  (https://pytorch.org/docs/stable/notes/cuda.html#environment-variables)
[1;34mwandb[0m: 
[1;34mwandb[0m: üöÄ View run [33mlocalization[0m at: [34mhttps://wandb.ai/zl3466-new-york-university/huggingface/runs/wolirl0z[0m
[1;34mwandb[0m: Find logs at: [1;35mwandb/run-20250403_014418-wolirl0z/logs[0m
W0403 01:44:35.359000 2671481 site-packages/torch/distributed/elastic/multiprocessing/api.py:897] Sending process 2671556 closing signal SIGTERM
E0403 01:44:35.574000 2671481 site-packages/torch/distributed/elastic/multiprocessing/api.py:869] failed (exitcode: 1) local_rank: 0 (pid: 2671555) of binary: /scratch/zl3466/env/thinking-in-street/bin/python
Traceback (most recent call last):
  File "/scratch/zl3466/env/thinking-in-street/bin/torchrun", line 8, in <module>
    sys.exit(main())
             ^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/torch/distributed/elastic/multiprocessing/errors/__init__.py", line 355, in wrapper
    return f(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/torch/distributed/run.py", line 918, in main
    run(args)
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/torch/distributed/run.py", line 909, in run
    elastic_launch(
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 138, in __call__
    return launch_agent(self._config, self._entrypoint, list(args))
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/scratch/zl3466/env/thinking-in-street/lib/python3.11/site-packages/torch/distributed/launcher/api.py", line 269, in launch_agent
    raise ChildFailedError(
torch.distributed.elastic.multiprocessing.errors.ChildFailedError: 
============================================================
./train/localization/grpo.py FAILED
------------------------------------------------------------
Failures:
  <NO_OTHER_FAILURES>
------------------------------------------------------------
Root Cause (first observed failure):
[0]:
  time      : 2025-04-03_01:44:35
  host      : gr065.hpc.nyu.edu
  rank      : 0 (local_rank: 0)
  exitcode  : 1 (pid: 2671555)
  error_file: <N/A>
  traceback : To enable traceback see: https://pytorch.org/docs/stable/elastic/errors.html
============================================================
